"""create vulnerability analysis views for LLM

Revision ID: 8b9c0d1e2f3a
Revises: 7a8b9c1d2e3f
Create Date: 2026-01-04 12:30:00.000000

"""
from typing import Sequence, Union

from alembic import op


# revision identifiers, used by Alembic.
revision: str = '8b9c0d1e2f3a'
down_revision: Union[str, None] = '7a8b9c1d2e3f'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Create views for vulnerability analysis"""

    # 1. Endpoints with reflected parameters (potential XSS)
    op.execute("""
        CREATE OR REPLACE VIEW reflected_parameters_view AS
        SELECT
            h.program_id,
            h.host,
            CONCAT(s.scheme, '://', h.host, ':', s.port, e.path) as full_url,
            e.path,
            e.methods,
            e.status_code,
            ip.name as param_name,
            ip.location as param_location,
            ip.param_type,
            ip.example_value,
            ip.is_array
        FROM input_parameters ip
        JOIN endpoints e ON ip.endpoint_id = e.id
        JOIN hosts h ON e.host_id = h.id
        JOIN services s ON e.service_id = s.id
        WHERE ip.reflected = true
        ORDER BY h.program_id, h.host, e.path;
    """)

    # 2. Endpoints with potential IDOR (normalized paths with {id})
    op.execute("""
        CREATE OR REPLACE VIEW idor_candidates_view AS
        SELECT
            h.program_id,
            h.host,
            CONCAT(s.scheme, '://', h.host, ':', s.port, e.path) as full_url,
            e.path,
            e.normalized_path,
            e.methods,
            e.status_code,
            count(DISTINCT ip.id) as param_count,
            array_agg(DISTINCT ip.name) FILTER (WHERE ip.name IS NOT NULL) as parameters
        FROM endpoints e
        JOIN hosts h ON e.host_id = h.id
        JOIN services s ON e.service_id = s.id
        LEFT JOIN input_parameters ip ON ip.endpoint_id = e.id
        WHERE
            (e.normalized_path LIKE '%{id}%' OR e.normalized_path LIKE '%{sha256}%')
            AND e.status_code IN (200, 201, 401, 403)
        GROUP BY h.program_id, h.host, s.scheme, s.port, e.path, e.normalized_path, e.methods, e.status_code
        ORDER BY h.program_id, count(DISTINCT ip.id) DESC;
    """)

    # 3. API endpoints grouped by normalized path (find API patterns)
    op.execute("""
        CREATE OR REPLACE VIEW api_pattern_analysis AS
        SELECT
            h.program_id,
            e.normalized_path,
            count(DISTINCT h.host) as host_count,
            count(DISTINCT e.id) as endpoint_count,
            array_agg(DISTINCT m.method) FILTER (WHERE m.method IS NOT NULL) as all_methods,
            array_agg(DISTINCT e.status_code) as all_status_codes,
            count(DISTINCT ip.id) as unique_params,
            array_agg(DISTINCT ip.name) FILTER (WHERE ip.name IS NOT NULL) as param_names
        FROM endpoints e
        JOIN hosts h ON e.host_id = h.id
        LEFT JOIN input_parameters ip ON ip.endpoint_id = e.id
        LEFT JOIN LATERAL unnest(e.methods) AS m(method) ON true
        WHERE e.normalized_path != '/'
        GROUP BY h.program_id, e.normalized_path
        HAVING count(DISTINCT e.id) > 1
        ORDER BY h.program_id, endpoint_count DESC;
    """)

    # 4. Sensitive headers analysis
    op.execute("""
        CREATE OR REPLACE VIEW sensitive_headers_view AS
        SELECT
            h.program_id,
            h.host,
            CONCAT(s.scheme, '://', h.host, ':', s.port, e.path) as full_url,
            e.path,
            hd.name as header_name,
            hd.value as header_value
        FROM headers hd
        JOIN endpoints e ON hd.endpoint_id = e.id
        JOIN hosts h ON e.host_id = h.id
        JOIN services s ON e.service_id = s.id
        WHERE
            lower(hd.name) IN (
                'x-api-key', 'authorization', 'x-auth-token',
                'x-csrf-token', 'cookie', 'set-cookie',
                'x-frame-options', 'content-security-policy',
                'access-control-allow-origin', 'server',
                'x-powered-by', 'x-aspnet-version'
            )
            OR lower(hd.value) LIKE '%token%'
            OR lower(hd.value) LIKE '%key%'
            OR lower(hd.value) LIKE '%secret%'
        ORDER BY h.program_id, h.host;
    """)

    # 5. Technology stack per host (for vulnerability matching)
    op.execute("""
        CREATE OR REPLACE VIEW host_technologies AS
        SELECT
            h.program_id,
            h.host,
            i.address,
            s.port,
            s.scheme,
            s.technologies,
            array_agg(DISTINCT hd.value) FILTER (
                WHERE lower(hd.name) IN ('server', 'x-powered-by', 'x-aspnet-version')
            ) as server_headers
        FROM hosts h
        LEFT JOIN host_ips hi ON hi.host_id = h.id
        LEFT JOIN ip_addresses i ON i.id = hi.ip_id
        LEFT JOIN services s ON s.ip_id = i.id
        LEFT JOIN endpoints e ON e.host_id = h.id AND e.service_id = s.id
        LEFT JOIN headers hd ON hd.endpoint_id = e.id
        WHERE s.technologies IS NOT NULL OR hd.value IS NOT NULL
        GROUP BY h.program_id, h.host, i.address, s.port, s.scheme, s.technologies
        ORDER BY h.program_id, h.host;
    """)

    # 6. Endpoints with query/body parameters (SQLi/XSS candidates)
    op.execute("""
        CREATE OR REPLACE VIEW injection_candidates_view AS
        SELECT
            h.program_id,
            h.host,
            CONCAT(s.scheme, '://', h.host, ':', s.port, e.path) as full_url,
            e.path,
            e.methods,
            e.status_code,
            count(DISTINCT ip.id) FILTER (WHERE ip.location = 'query') as query_params,
            count(DISTINCT ip.id) FILTER (WHERE ip.location = 'body') as body_params,
            count(DISTINCT ip.id) FILTER (WHERE ip.location = 'path') as path_params,
            array_agg(DISTINCT ip.name) FILTER (WHERE ip.location IN ('query', 'body')) as injectable_params
        FROM endpoints e
        JOIN hosts h ON e.host_id = h.id
        JOIN services s ON e.service_id = s.id
        LEFT JOIN input_parameters ip ON ip.endpoint_id = e.id
        WHERE
            e.status_code IN (200, 400, 500)
            AND EXISTS (
                SELECT 1 FROM input_parameters
                WHERE endpoint_id = e.id
                AND location IN ('query', 'body')
            )
        GROUP BY h.program_id, h.host, s.scheme, s.port, e.path, e.methods, e.status_code
        ORDER BY h.program_id, (count(DISTINCT ip.id)) DESC;
    """)

    # 7. SSRF candidates (URLs with URL parameters)
    op.execute("""
        CREATE OR REPLACE VIEW ssrf_candidates_view AS
        SELECT
            h.program_id,
            h.host,
            CONCAT(s.scheme, '://', h.host, ':', s.port, e.path) as full_url,
            e.path,
            e.methods,
            ip.name as param_name,
            ip.location,
            ip.example_value
        FROM input_parameters ip
        JOIN endpoints e ON ip.endpoint_id = e.id
        JOIN hosts h ON e.host_id = h.id
        JOIN services s ON e.service_id = s.id
        WHERE
            (
                lower(ip.name) IN ('url', 'uri', 'link', 'src', 'source', 'target', 'redirect', 'callback', 'webhook')
                OR lower(ip.example_value) LIKE 'http%'
                OR lower(ip.example_value) LIKE '%://%'
            )
            AND e.status_code IN (200, 302, 400)
        ORDER BY h.program_id, h.host;
    """)

    # 8. File upload candidates
    op.execute("""
        CREATE OR REPLACE VIEW file_upload_candidates AS
        SELECT
            h.program_id,
            h.host,
            CONCAT(s.scheme, '://', h.host, ':', s.port, e.path) as full_url,
            e.path,
            e.methods,
            count(DISTINCT ip.id) FILTER (WHERE ip.param_type = 'file') as file_params,
            array_agg(DISTINCT ip.name) FILTER (WHERE ip.param_type = 'file') as file_param_names
        FROM endpoints e
        JOIN hosts h ON e.host_id = h.id
        JOIN services s ON e.service_id = s.id
        LEFT JOIN input_parameters ip ON ip.endpoint_id = e.id
        WHERE
            EXISTS (
                SELECT 1 FROM input_parameters
                WHERE endpoint_id = e.id
                AND param_type = 'file'
            )
            OR e.path LIKE '%upload%'
            OR e.path LIKE '%file%'
        GROUP BY h.program_id, h.host, s.scheme, s.port, e.path, e.methods
        ORDER BY h.program_id, h.host;
    """)

    # 9. Admin/Debug endpoints
    op.execute("""
        CREATE OR REPLACE VIEW admin_debug_endpoints AS
        SELECT
            h.program_id,
            h.host,
            CONCAT(s.scheme, '://', h.host, ':', s.port, e.path) as full_url,
            e.path,
            e.methods,
            e.status_code
        FROM endpoints e
        JOIN hosts h ON e.host_id = h.id
        JOIN services s ON e.service_id = s.id
        WHERE
            lower(e.path) LIKE '%admin%'
            OR lower(e.path) LIKE '%debug%'
            OR lower(e.path) LIKE '%test%'
            OR lower(e.path) LIKE '%console%'
            OR lower(e.path) LIKE '%config%'
            OR lower(e.path) LIKE '%swagger%'
            OR lower(e.path) LIKE '%api-docs%'
            OR lower(e.path) LIKE '%graphql%'
        ORDER BY h.program_id, e.status_code, h.host;
    """)

    # 10. CORS misconfiguration candidates
    op.execute("""
        CREATE OR REPLACE VIEW cors_analysis AS
        SELECT
            h.program_id,
            h.host,
            CONCAT(s.scheme, '://', h.host, ':', s.port, e.path) as full_url,
            e.path,
            hd.value as cors_header_value
        FROM headers hd
        JOIN endpoints e ON hd.endpoint_id = e.id
        JOIN hosts h ON e.host_id = h.id
        JOIN services s ON e.service_id = s.id
        WHERE
            lower(hd.name) = 'access-control-allow-origin'
            AND (
                hd.value = '*'
                OR lower(hd.value) LIKE '%null%'
            )
        ORDER BY h.program_id, h.host;
    """)


def downgrade() -> None:
    """Drop vulnerability analysis views"""
    op.execute("DROP VIEW IF EXISTS reflected_parameters_view;")
    op.execute("DROP VIEW IF EXISTS idor_candidates_view;")
    op.execute("DROP VIEW IF EXISTS api_pattern_analysis;")
    op.execute("DROP VIEW IF EXISTS sensitive_headers_view;")
    op.execute("DROP VIEW IF EXISTS host_technologies;")
    op.execute("DROP VIEW IF EXISTS injection_candidates_view;")
    op.execute("DROP VIEW IF EXISTS ssrf_candidates_view;")
    op.execute("DROP VIEW IF EXISTS file_upload_candidates;")
    op.execute("DROP VIEW IF EXISTS admin_debug_endpoints;")
    op.execute("DROP VIEW IF EXISTS cors_analysis;")
